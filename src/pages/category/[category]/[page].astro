---
import type { CollectionEntry } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import BaseLayout from "@/base/BaseLayout.astro";
import ListCategories from "@/components/post/ListCategories.astro";
import ListPosts from "@/components/post/ListPosts.astro";
import Pagination from "@/components/ui/Pagination.astro";
import TitlePage from "@/components/ui/TitlePage.astro";
import { getCategories, getPosts } from "@/lib/post";
import { siteConfig } from "@/lib/site-data";
import { sluglify, unsluglify } from "@/lib/sluglify";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const categories = await getCategories();
  const allPosts = await getPosts();

  return categories.flatMap((category: string) => {
    const unsluglifyNameCategory = unsluglify(category.toLowerCase());
    const filteredPosts = allPosts.filter(
      (post) => post.data.category.toLowerCase() === unsluglifyNameCategory,
    );

    return paginate(filteredPosts, {
      params: {
        category: sluglify(category.toLowerCase()),
      },
      pageSize: siteConfig.paginationSize,
    });
  });
};

const params = Astro.params;
const { page } = Astro.props as { page: Page<CollectionEntry<"blog">> };

const categoryParam = String(params.category ?? "");
const unsluglifyNameCategory = unsluglify(categoryParam.toLowerCase());
const posts = page.data;
---

<BaseLayout
  title={unsluglifyNameCategory.charAt(0).toUpperCase() +
    unsluglifyNameCategory.slice(1)}
>
  <TitlePage
    title={unsluglifyNameCategory}
    iconName="album-line-duotone"
    iconClass="text-anchor"
  />
  <ListCategories activeCategory={categoryParam} />
  <ListPosts posts={posts} />
  <Pagination page={page} />
</BaseLayout>
