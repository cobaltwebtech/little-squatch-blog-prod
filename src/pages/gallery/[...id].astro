---

import { getCollection } from "astro:content";
import { CldImage } from "astro-cloudinary";
import { getCldImageUrl } from "astro-cloudinary/helpers";
import BaseLayout from "@/base/BaseLayout.astro";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbSeparator,
} from "@/components/starwind/breadcrumb";
import TitlePage from "@/components/ui/TitlePage.astro";

import "photoswipe/style.css";

export async function getStaticPaths() {
  const albums = await getCollection("albums");

  const paths = Object.values(albums).map((album) => {
    return {
      params: {
        id: album.id,
      },
      props: {
        album,
      },
    };
  });

  return paths;
}

const { album } = Astro.props;

// Get all album images from the collection
const allImages = await getCollection("albumImages");

// Filter images that belong to this album's folder
const images = allImages
  .filter((img) => img.id.startsWith(album.data.folder))
  .map((img) => ({
    src: img.id,
    width: img.data.width,
    height: img.data.height,
  }));
---

<BaseLayout title={album.data.title}>
  <section class="text-center">
    <h1
      class="text-2xl font-bold tracking-wide sm:text-3xl md:text-4xl"
      transition:name={`${album.id}-title`}
    >
      {album.data.title}
    </h1>
    <p class="my-4 text-xl" transition:name={`${album.id}-description`}>
      {album.data.description}
    </p>
    <Breadcrumb>
      <BreadcrumbList>
        <BreadcrumbItem>
          <BreadcrumbLink href="/">Home</BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbSeparator />
        <BreadcrumbItem>
          <BreadcrumbLink href="/gallery">Back to Gallery</BreadcrumbLink>
        </BreadcrumbItem>
      </BreadcrumbList>
    </Breadcrumb>
  </section>
  <section
    class="mx-auto my-8 grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"
    data-pswp-gallery
  >
    {
      images.map((image: { src: string; width: number; height: number }) => {
        const fullSizeUrl = getCldImageUrl({
          src: image.src,
          width: 2400,
          format: "auto",
          quality: "auto",
        });
        
        return (
          <a
            href={fullSizeUrl}
            data-pswp-width={image.width}
            data-pswp-height={image.height}
            class="contents"
            target="_blank"
          >
            <CldImage
              src={image.src}
              alt={`Image from ${album.data.title} album`}
              format="avif"
              class="hover:border-border rounded border border-transparent transition-all duration-300 ease-in-out hover:shadow-lg"
              loading="lazy"
            />
          </a>
        );
      })
    }
  </section>
  <Breadcrumb>
    <BreadcrumbList>
      <BreadcrumbItem>
        <BreadcrumbLink href="/">Home</BreadcrumbLink>
      </BreadcrumbItem>
      <BreadcrumbSeparator />
      <BreadcrumbItem>
        <BreadcrumbLink href="/gallery">Back to Gallery</BreadcrumbLink>
      </BreadcrumbItem>
    </BreadcrumbList>
  </Breadcrumb>
</BaseLayout>
<!-- Initialize and render Photo Swipe plugin -->
<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";

  document.addEventListener("astro:page-load", () => {
    const leftArrowSVGString =
      '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"><path fill="#fff" d="M17.75 19a.75.75 0 0 1-1.32.488l-6-7a.75.75 0 0 1 0-.976l6-7A.75.75 0 0 1 17.75 5z" opacity="0.5"/><path fill="#fff" fill-rule="evenodd" d="M13.488 19.57a.75.75 0 0 0 .081-1.058L7.988 12l5.581-6.512a.75.75 0 1 0-1.138-.976l-6 7a.75.75 0 0 0 0 .976l6 7a.75.75 0 0 0 1.057.082" clip-rule="evenodd"/></svg>';
    const rightArrowSVGString =
      '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"><path fill="#fff" d="M6.25 19a.75.75 0 0 0 1.32.488l6-7a.75.75 0 0 0 0-.976l-6-7A.75.75 0 0 0 6.25 5z" opacity="0.5"/><path fill="#fff" fill-rule="evenodd" d="M10.512 19.57a.75.75 0 0 1-.081-1.058L16.012 12l-5.581-6.512a.75.75 0 1 1 1.139-.976l6 7a.75.75 0 0 1 0 .976l-6 7a.75.75 0 0 1-1.058.082" clip-rule="evenodd"/></svg>';
    const closeSVGString =
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="#fff" d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10" opacity="0.5"/><path fill="#fff" d="M8.97 8.97a.75.75 0 0 1 1.06 0L12 10.94l1.97-1.97a.75.75 0 1 1 1.06 1.06L13.06 12l1.97 1.97a.75.75 0 0 1-1.06 1.06L12 13.06l-1.97 1.97a.75.75 0 0 1-1.06-1.06L10.94 12l-1.97-1.97a.75.75 0 0 1 0-1.06"/></svg>';
    const zoomSVGString =
      '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"><path fill="#fff" d="M11.157 20.313a9.157 9.157 0 1 0 0-18.313a9.157 9.157 0 0 0 0 18.313" opacity="0.5"/><path fill="#fff" fill-rule="evenodd" d="M11.157 8.024c.399 0 .722.324.722.723v1.687h1.687a.723.723 0 1 1 0 1.446H11.88v1.687a.723.723 0 1 1-1.445 0V11.88H8.747a.723.723 0 1 1 0-1.446h1.687V8.747c0-.399.323-.723.723-.723" clip-rule="evenodd"/><path fill="#fff" d="m17.1 18.122l3.666 3.666a.723.723 0 0 0 1.023-1.022L18.122 17.1a9 9 0 0 1-1.022 1.022"/></svg>';

    const lightbox = new PhotoSwipeLightbox({
      arrowPrevSVG: leftArrowSVGString,
      arrowNextSVG: rightArrowSVGString,
      closeSVG: closeSVGString,
      zoomSVG: zoomSVGString,
      gallery: "[data-pswp-gallery]",
      children: "a",
      pswpModule: () => import("photoswipe"),
    });

    lightbox.init();
  });
</script>
